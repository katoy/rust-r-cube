# 2x2 ルービックキューブ

Rustで実装した2x2ルービックキューブのGUIプログラムです。超高速な双方向BFSソルバー機能を搭載しています。

## スクリーンショット

### メイン画面

![メイン画面](images/image-001.png)

初期状態のキューブと操作パネル。3Dビューで直感的に操作できます。

## 特徴

- 🎮 **インタラクティブなGUI**: モダンで使い勝手の良いインターフェース
- 🚀 **超高速最短解ソルバー**: 双方向BFSと最適化されたデータ構造により、最短解を瞬時に探索
- 📊 **リアルタイム進捗表示**: 解法探索中の進捗をプログレスバーで可視化
- 🎯 **解決モードの切り替え**: 「色のみを揃える」か「矢印の向きまで完璧に揃える」かを自由に選択可能
- 📸 **6面スキャン入力**: 実物のルービックキューブの状態を視覚的に入力できる機能
- 💾 **ファイル保存/読込**: キューブの状態をファイルに保存・読み込み可能（テキスト形式で手動編集も可）
- ✨ **スムーズなアニメーション**: イージング関数を使用した滑らかな回転移動
- 🔄 **向きの可視化**: 各ステッカーに矢印マークを表示し、ステッカー自体の向きを視覚化
- ⚙️ **アニメーション制御**: 速度調整、再生/一時停止、ステップごとの操作

## 必要要件

- Rust 1.70以上

## ビルドと実行

```bash
# リリースビルド
cargo build --release

# 実行
cargo run --release
```

## 使い方

### 基本操作

- **スクランブル**: キューブをランダムに5〜10手混ぜます
- **リセット**: キューブを初期状態（完成状態）に戻します
- **解決設定**:
  - **向き無視**: 各面の色さえ揃えば完成とみなします (最大深度: 11)
  - **向きも揃える**: 色に加えて、ステッカーの矢印まで全て初期状態に揃えます (最大深度: 14)
- **解法を探す**: 現在の状態から最短解を探索します（進捗バーで進行状況を確認できます）

### 6面スキャン入力

実際のルービックキューブの状態をアプリに入力する機能です。実物のキューブを見ながら、各面の色を手動で設定できます。

1. **📸 6面スキャン入力** ボタンをクリック
2. 各面（上→右→前→下→左→後）の順に4つのステッカーの色をクリックして選択
3. 画面上のカラーパレットから対応する色を選択
4. 全6面（24ステッカー）の入力が完了したら **✓ 完了** をクリック
5. 入力を中断したい場合は **✗ キャンセル** をクリック

> **ヒント**: 各面の入力順序は、画面の指示に従ってください。入力中の面がハイライトされます。

### ファイルの読み込み/保存

キューブの現在の状態をファイルに保存したり、以前保存した状態を読み込むことができます。

- **💾 保存**: 現在のキューブの状態を `cube_state.txt` に保存します
- **📂 読込**: `cube_state.txt` からキューブの状態を読み込みます

ファイルフォーマットは以下の形式です：

```text
     WWWW
GGGG RRRR BBBB OOOO
     YYYY
```

各文字は色を表します（W=白、Y=黄、R=赤、O=オレンジ、B=青、G=緑）。

各面の4つのステッカーは、**左上→右上→左下→右下**の順で記載します。例えば、面の色配置が以下の場合：

```text
白 橙
黄 緑
```

ファイルには `WOYG` と記載します。この形式で手動編集も可能です。

### 回転操作

キューブの各面を回転させる操作です。ボタンをクリックすると、対応する面が90度回転します。

#### 基本操作（時計回り）

- **R** (Right): 右面を時計回りに90度回転
- **L** (Left): 左面を時計回りに90度回転
- **U** (Up): 上面を時計回りに90度回転
- **D** (Down): 下面を時計回りに90度回転
- **F** (Front): 前面を時計回りに90度回転
- **B** (Back): 背面を時計回りに90度回転

#### 逆回転操作（反時計回り）

各操作に `'` (プライム) を付けると、反時計回りに90度回転します：

- **R'** (R-prime): 右面を反時計回りに90度回転
- **L'** (L-prime): 左面を反時計回りに90度回転
- **U'** (U-prime): 上面を反時計回りに90度回転
- **D'** (D-prime): 下面を反時計回りに90度回転
- **F'** (F-prime): 前面を反時計回りに90度回転
- **B'** (B-prime): 背面を反時計回りに90度回転

> **ヒント**: 任意の操作を4回繰り返すと元の状態に戻ります（例: R → R → R → R = 元の状態）

### 解法ステップ操作

解法が見つかると、一歩ずつ進めたり戻したりできるコントローラーが表示されます。

## プロジェクト構造

```text
src/
├── main.rs           # エントリーポイント
├── lib.rs            # ライブラリルート
├── cube.rs           # キューブの状態管理と回転論理
├── solver.rs         # 最適化された双方向BFSソルバー
└── gui/
    ├── mod.rs        # GUIモジュール
    ├── app.rs        # アプリケーション状態・ライフサイクル管理
    ├── renderer.rs   # 2D描画ヘルパー
    ├── renderer_3d.rs # 3D描画エンジン
    └── controls.rs   # 操作パネルUI
```

## 技術詳細

### 最適化されたソルバー

#### アルゴリズム

- **双方向BFS**: 開始状態と目標状態（24通りの完成状態）の両方から同時に探索することで、探索空間を劇的に削減。
- **時間計算量**: O(b^(d/2)) - 単方向BFSのO(b^d)と比較して大幅に高速

#### パフォーマンス最適化

- **FxHash**: `rustc-hash` (FxHashMap) を採用し、ハッシュマップの操作を高速化
- **容量事前確保**: HashMapとVecDequeの容量を事前に確保し、再ハッシュのコストを削減
- **Entry API**: `contains_key` + `insert` の代わりに `entry` APIを使用し、効率的なHashMapアクセスを実現
- **clone削減**: 不要なCubeのclone操作を削減し、メモリアロケーションを最小化
- **進捗送信最適化**: 進捗情報の送信頻度を調整し、チャネル送信のオーバーヘッドを削減

#### メモリ最適化

- **親への参照のみ保持**: 各探索ノードで操作履歴を保持せず、「親への参照」のみを保持
- **完成状態のキャッシュ**: `OnceLock` を使用し、全24通りの解決済み状態を一度だけ計算して再利用

### カバレッジと品質

- **テスト網羅率**: `solver.rs` および `cube.rs` のコアロジックにおいて、非常に高いコードカバレッジを達成しています。

| File             |  Regions   | Functions  |   Lines    |
| :--------------- | :--------: | :--------: | :--------: |
| `src/cube.rs`    |   96.15%   |   90.24%   |   96.48%   |
| `src/solver.rs`  |   95.89%   |  100.00%   |   95.10%   |
| **Total (Core)** | **96.03%** | **94.44%** | **96.01%** |

- **向きバグの修正**: 全 12 操作（R, L, U, D, F, B およびその逆操作）のマッピングと向きの更新ロジックを、3D物理シミュレーションに基づいて全面的に修正しました。
- **検証済み**: 統合テスト（`tests/test_orientation_exhaustive.rs`）により、全24ステッカーの座標と向きが全操作において数学的に正しいことを網羅的に検証済みです。
- **検証済み**: 多様なスクランブルパターンおよび全体回転状態での正当性をテストで確認。

## ライセンス

MIT License

## 開発・検証

```bash
# 開発ビルド
cargo build

# テスト (高速化の成果を確認できます)
cargo test

# カバレッジ計測
cargo llvm-cov --summary-only

# クリーンアップ
cargo clippy && cargo fmt
```
